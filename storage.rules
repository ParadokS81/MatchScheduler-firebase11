rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Temp uploads - authenticated users can write to their path
    match /logo-uploads/{teamId}/{userId}/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if false; // Only Cloud Function reads
    }

    // Processed logos - public read
    match /team-logos/{teamId}/{logoId}/{fileName} {
      allow read: if true;
      allow write: if false; // Only Cloud Function writes
    }

    // Avatar temp uploads - authenticated users can write to their own path
    match /avatar-uploads/{userId}/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if false; // Only Cloud Function reads
    }

    // Processed avatars - public read
    match /user-avatars/{userId}/{fileName} {
      allow read: if true;
      allow write: if false; // Only Cloud Function writes
    }

    // Feedback screenshot uploads - authenticated users write to own path
    match /feedback-uploads/{userId}/{fileName} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if true; // Public read so download URL works for admin review
    }

    // Voice recordings â€” uploaded by Quad bot via Admin SDK
    // Public read: discovery requires knowing demoSha256 (not guessable)
    // Privacy is enforced at Firestore discovery layer, not storage

    // New multi-clan format (Phase 2+)
    match /voice-recordings/{teamId}/{demoSha256}/{fileName} {
      allow read: if true;
      allow write: if false; // Only Admin SDK (Quad bot) can write
    }

    // Legacy PoC format (existing recordings)
    match /voice-recordings/{demoSha256}/{fileName} {
      allow read: if true;
      allow write: if false; // Only Admin SDK (Quad bot) can write
    }
  }
}
